# .github/workflows/nuget-publish-template.yml
name: Publish NuGet Package (Reusable)

on:
  workflow_call:
    inputs:
      project-path:
        description: 'Path to the .csproj file'
        required: true
        type: string
      tag-prefix:
        description: 'Tag prefix to extract version from (e.g., "cache-v" for tags like cache-v1.0.0)'
        required: true
        type: string
    secrets:
      NUGET_API_KEY:
        required: true

env:
  DOTNET_VERSION: '10.0.x'
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/${{ inputs.tag-prefix }}}
          echo "VERSION=$TAG" >> $GITHUB_OUTPUT
          echo "Extracted version: $TAG"

      - name: Restore dependencies
        run: dotnet restore ${{ inputs.project-path }}

      - name: Build
        run: dotnet build ${{ inputs.project-path }} --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --configuration Release --verbosity normal

      - name: Pack NuGet package
        run: |
          dotnet pack ${{ inputs.project-path }} \
            --configuration Release \
            --no-build \
            --output ./nupkgs \
            -p:PackageVersion=${{ steps.version.outputs.VERSION }}

      - name: Publish to NuGet
        run: |
          dotnet nuget push ./nupkgs/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source ${{ env.NUGET_SOURCE }} \
            --skip-duplicate
